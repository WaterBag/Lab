---
title: 流水线
description: 您可以轻松创建和运行复杂的研究流水线。
---

我们提供了一个 **流水线** 可视化编辑器，简化了将多个Python脚本转换为批处理作业或工作流的过程。

它是由一个或多个组件编排而成的，这些组件在很多情况下相互连接以定义执行依赖关系。组件是可配置组件的实例，通常只实现一个工作单元以使其可重复使用。一个工作单元可以代表任何任务，如加载数据、预处理数据、分析数据、训练机器学习模型等。

## 流水线 `.cpw` 文件

我们的流水线功能以扩展名为`.cpw`的文件进行管理，它的内容是一个我们定义了schema的JSON文本，其记录了流水线的所有内容。

### 创建
可以从启动页点击这个图标，新建一个`.cpw`文件到当前目录下：

![创建流水线](/imgs/content/tutorial/workspace/cpw/create.png){style="max-width: 120px"}

此时我们可以看到在文件目录下创建了一个 `untitled.cpw` 文件，并且在内容区可以看到已经打开了此文件：

![流水线视图](/imgs/content/tutorial/workspace/cpw/view.png)

其中网格的部分就是我们进行编排流水线的区域，我们称为**画布**区域。

> 和notebook的`.ipynb`文件一样，打开`.cpw`文件将会自动创建一个python3内核，如果在创建时显示了内核选择框，请选择python3内核，因为我们的流水线功能目前**只支持Python**{style="color: red"}组件的运行。

本篇教程后续的内容都将以这个流水线的内容区展开。

## 入门

### 组件

组件是流水线中的一个最小运行单元，每个组件都包含多个可修改的配置项：
- 基础配置
    - **组件名**：组件在画布上显示的名称。
    - **组件描述**：描述组件的作用和使用方法等，可为空。

- 运行配置
    - **参数**：定义组件在运行时需要填入的参数，参数值可以在代码中读取。
    - **输入**：定义组件在运行时需要读取的其他组件输出的值。
    - **输出**：声明组件在运行完成后输出的值，组件所有的输出值都会被渲染到输出渲染区，并且输出的值可以被其他组件作为其输入值读取。
    - **代码**：组件执行的代码，在代码中可以动态读取组件的参数值和输入值。

> 和notebook的单元格不同，流水线的多个组件之间运行时是无法直接互相访问组件内的变量的，因为组件的代码实际上会被包裹在一个函数内执行，组件内定义的各个变量不会污染内核的全局命名空间，如果组件之间需要访问内部值，则需要使用组件的输入、输出。


### 组件列表面板
位于内容区的左侧，所有可用的组件都按分类在这个列表目录下，我们将从此处对画布插入组件。

系统预置了多个组件，涵括了多个常用的算法，您也可以[配置自己常用的组件](#新建组件配置)到组件列表中，以便在其他的流水线甚至其他项目工作区使用它。


### 组件输出渲染面板
位于内容区的下方，当选中画布中的组件时，将会在此面板渲染组件运行后的所有输出。

默认情况下渲染面板是收起的，点击渲染面板顶部右侧按钮进行展开和收起，也可以**双击组件**快捷展开。

渲染面板在展开状态时，可以通过拖动顶部边缘来调整渲染面板的大小:

![渲染面板调整](/imgs/content/tutorial/workspace/cpw/output-resize.gif)


### 组件运行参数面板
位于内容区的右侧，当选中画布中的组件时，将会在右侧显示该面板，用于填入组件运行时的参数值和输入值。

面板的内容分为三个板块，分别是 “参数”、“输入”、“输出” ，它们的内容实际上是根据组件配置生成。

> 例如，组件配置中如果定义了一个参数项，则表示组件在运行时需要接受一个对应的参数值。而这个参数值就需要在本面板中的参数部分填入参数的值。

如图，这个是由某个组件的配置生成的对应三个板块内容：在参数部分填入组件所需的各项参数值；在输入部分选择接收其他组件的某个输出值；在输出面板查看组件的所有输出值。

![运行时配置视图](/imgs/content/tutorial/workspace/cpw/cfg-view.png){style="max-width: 500px"}

详细请参阅：[组件配置](#组件配置)。

------

## 操作指引
内容区的顶部包含了一行操作按钮，也可以在画布区域对组件单击右键唤出包含多个操作的上下文菜单。

### 插入组件到画布
从组件列表中选择目标组件，通过 **拖-拉-放** 就可以非常轻松地把组件插入到画布当中，对画布中的组件可以直接拖拽以重新调整他们的位置。

![拖放组件](/imgs/content/tutorial/workspace/cpw/add-cell.gif){style="max-width: 500px"}


### 组件间的连接
当鼠标移动到组件上时，组件会出现它的连接桩，按住某个连接桩将会拉出一条连接线，可以把其他组件的连接桩上。

当鼠标移到到已经存在的连接线上，可以点击出现的删除按钮断开连接线。

![组件连接](/imgs/content/tutorial/workspace/cpw/connecting.gif){style="max-width: 500px"}

组件的连接关系将会影响组件的运行顺序和组件间的输入输出取值：
1. 上图的组件连接后，对于`组件2`来说，`组件1`是它的**前序组件**，`组件3`和`组件4`都是它的**后序组件**。也就是说，连接线的箭头指向的就是它的后序组件。而没有被任何箭头指向的组件就是**根组件**。
2. 若某个组件配置了输入项，需要在运行时指定读取其他组件的输出值时，它**只能选择它的所有前序组件的其中一个输出值**。也就是说`组件2`只能读到`组件1`的输出值。
3. 当同时运行连接的多个组件时，将会从**前序组件**开始运行，并依次往它所有的**后序组件**运行。也就是按箭头方向运行。

![运行示例](/imgs/content/tutorial/workspace/cpw/running.gif){style="max-width: 500px"}


### 运行组件

组件的运行有3种模式：
- **运行单个组件**：单独运行目标组件。
- **运行至所选组件**：从目标组件的所有前序组件运行至目标组件。在运行过程中遇到其他无关的连接分支将会忽略。
- **运行所有**：从所有的根节点开始运行所有组件。

可以从右键菜单和顶部操作按钮触发运行操作。


> 运行前系统会检查所有待运行的组件是否已经填入必须的参数值和选择必须的输入值，如果有某个组件检查不通过，将会取消运行。检查不通过的组件将会高亮显示，表示其需要补充运行的参数值或指定输入值。

更详细的运行流程请参阅：[深入-运行](#运行)。

### 组件配置
当您需要修改某个组件的详细配置或代码时，需要打开**配置修改器**:
- 选中目标组件后，在内容区右侧的组件运行参数面板中，可以点击下方的“编辑组件配置”按钮打开配置修改器。
- 单击右键组件显示的菜单中点击“编辑组件配置”。

修改画布中的组件的配置时，不会影响其他组件，只会更改当前组件；接下来我们主要关注的是组件的运行配置。

#### 参数
组件可以看作实现了特定功能的函数；为组件配置参数项相当于为函数声明入参；而运行组件相当于调用函数；在运行组件时需要填入参数值，相当于调用函数时的传参。

已经配置的参数项会显示在表格中，修改参数项或者新增参数时，右侧会弹出参数配置表单。

![查看参数配置](/imgs/content/tutorial/workspace/cpw/params-table.png)

- **变量名**：一个合法的python变量名，是在组件代码中读取参数值时对应的标识符。
- **名称**：参数项的名称。
- **说明**：用于补充参数的额外描述，可为空。
- **类型**：指定参数值的类型，运行时填入的参数形式将会不同。
    - **字符串**：可以填入任意的的文本。
    - **数值**：只能填入数值。
    - **选项**：只能选择预设的选项。
    - **布尔值**：通过勾选框指定值为`True`或`False`。
- **默认值**：若参数项设置了默认值，创建组件时将该参数会填入默认值，在运行前可以不用再手动填入。可为空。
- **是否必填**：指定为必填的参数项在运行时必须填入参数值，否则将会取消运行；若参数非必填并且运行时留空，那么在代码中读取的值将会是 `None`。

#### 输入
组件可以在运行时从它的所有**前序组件的输出值**中选择一个，用于在流水线中传递数据。

可以直接在输入表格中新增或更改输入项。

![输入配置](/imgs/content/tutorial/workspace/cpw/income.png)

- **变量名**：一个合法的python变量名，在组件代码中可以直接读取这个变量。
- **名称**：输入项的名称。
- **说明**：用于补充输入的额外描述，可为空。
- **是否必填**：指定为必填的输入项在运行时必须选择输入值，否则将会取消运行；若参数非必填并且运行时留空，那么在代码中读取的值将会是 `None`。

#### 输出
指定输出组件中指定的变量名，所有的输出值都会被渲染，并且可以被后续组件的输入接收值。

**指定的输出变量必须在组件代码中存在**，否则会抛出运行时错误。

![输出配置](/imgs/content/tutorial/workspace/cpw/outgo.png)

如示例图，输出项指定的变量 `out_data` 在组件运行完成后系统会读取这个变量，并传递到后序组件中。

#### 代码
组件实际运行的代码。以下是在组件代码中读取参数值和输入值的示例。

对参数值的读取需要使用**插值语法**进行获取，具体请参阅：[参数的读取](#参数的读取)。

![代码示例](/imgs/content/tutorial/workspace/cpw/code.png){style="max-width: 400px"}

### 新建组件配置
在组件列表的顶部点击“+”按钮，可以唤出组件列表打开配置修改器。

![新建组件配置](/imgs/content/tutorial/workspace/cpw/create-cell.png){style="max-width: 250px"}

> 注意：组件类型在新建后无法修改。


### 重置组件配置
选中目标组件后，在内容区右侧的组件运行参数面板中，点击最底部的“重置组件配置按钮”，将会把这个组件的所有配置都恢复到刚创建时的状态。

例如：画布上有一个组件，它一开始创建的时候是从组件列表中的“读取CSV文件”拖放至画布中的，那么这个组件即使所有配置都更改了，在重置组件配置的时候都会将其重置为“读取CSV文件”的初始状态。如果源组件在组件列表中已被删除，那么将无法重置。

![重置组件配置](/imgs/content/tutorial/workspace/cpw/create-cell.png){style="max-width: 250px"}

------

## 深入

### 参数的读取

前文有提及到：在组件代码中读取参数值，需要使用**插值语法**，即使用双大括号包裹参数变量名 `{{变量名}}`。

```python
# 组件代码，读取参数值示例
# 假设组件配置了一个名为 p_1 的参数，在运行时 p_1 的值指定了为 123

value = {{p_1}} # 读取变量名为 p_1 的参数值
# 在运行时，这个语句相等于
value = 123

# 插值语法可以放在代码中的任何位置：

value = 10 + {{p_1}}
# 在运行时，这个语句相等于
value = 10 + 123

value = 'hello {{p_1}}'
# 在运行时，这个语句相等于
value = 'hello 123'

# 假设组件配置了一个名为 p_2 的布尔值参数，在运行时 p_2 的值指定了为 True
if {{p2}}:
  print('True')
# 在运行时，这个语句相当于
if True:
  print('True')
```

在上面的代码示例中可以发现，**插值语法可以出现在代码中的任何位置**，实际上是利用了模板语法，在代码运行前根据填入的参数值，把组件代码中插值语法直接替换成对应的参数值之后再执行。

#### 不同参数类型
在组件配置中，我们支持输入的类型有四种：字符串、数值、选项、布尔值。实际上，这些参数值类型是用于限制参数值填入时的格式的。

而对于组件代码通过插值语法读取参数值的时候，所有参数值的类型都不重要，它的都是直接替换代码中的插值语法的。

所以当我们期望代码中使用某个变量**读取字符串值**的时候，我们需要手动为其包裹引号：

```python
# 假设组件配置了一个名为 str_1 的字符串类型参数，在运行前为它的输入框填入内容：我是一段任意文本
value = {{str_1}}
# 在运行时，这个语句相当于
value = 我是一段任意文本

# 很显然，上述的语句在python中会出现错误 (NameError: name '我是一段任意文本' is not defined)

# 当我们期望其读取成字符串时，我们需要包裹引号
value = '{{str_1}}'
# 在运行时，这个语句相当于
value = '我是一段任意文本'
```

同理，即使参数类型是数值或是布尔值，在读取参数值时，如果使用引号包裹，那么它们的值都会是字符串：

```python
# 假设组件配置了名为 num_1 数值类型的参数，运行时值为 123
value = {{num_1}}
value = '{{num_1}}'
# 在运行时，这两个语句相当于：
value = 123
value = '123'
# 布尔值也是同理，不过插入的值将会是True或者False，而不是123
```

当非必填参数在运行时留空了，那么它的参数值将会是 `None`
```python
# 假设组件配置了名为 p_1 的非必填参数，运行时值留空，值就会是None
value = {{p_1}}
value = '{{p_1}}'
# 在运行时，这两个语句相当于：
value = None
value = 'None'
```

#### 不固定类型的值
当我们期望接收的参数值可能同时是字符串值或者其他值的情况下，使用插值语法可能会面临的问题：

例如，组件有一个参数是选项类型，变量名为 `opt_1` 并且配置了两个选项，选项值分别是 `123` 和 `一段文本`，在组件代码中使用 `value = {{opt_1}}` 进行读取：
- 当选择值为`123`的选项时，语句相当于 `value = 123`{lang="python"} 。
- 当选择值为`一段文本`的选项时，语句相当于 `value = 一段文本` 。

很显然，当选择前者时，和我们期望的一致，将会读取到一个数值；但当选择后者时，语句将会报错，我们期望的是读取到字符串值，也就是 `value = '一段文本'`{lang="python"} 。

在这种情况下，如果我们为了正确拿到字符串类型的值的话，根据前文，我们可能会想到需要使用引号包裹插值语法: `value = '{{opt_1}}'`。但是很显然，这时候当我们选择值为`123`的选项时，它也会相当于`value = '123'`，而非我们期望读取的数值了。

为了解决这种问题，我们就需要理解插值语法的概念：**参数值直接替换代码中的插值语法**；我们把选项值 `一段文本` 更改为有引号包裹的 `'一段文本'`，此时代码中的 `value = {{opt_1}}` 在选择它时就相当于 `value = '一段文本'`，就和我们预期需要的数据类型一致了。

![选项配置](/imgs/content/tutorial/workspace/cpw/cfg-options.png)

#### 更进一步
当理解了插值语法的逻辑后，我们知道了任何内容都可以在运行时插入到组件代码中。

那么，当我们声明了一个字符串类型的参数，在运行参数面板中这个参数值的输入框可以输入任意的**单行内容**{style="color: red"}，也就是说，我可以输入**字典**、**数组**、甚至是**代码**（只能是单行语句）。

```python
# 假设这是一个组件代码配置，直接写一个插值语法在里面
{{code}}
```

![插值代码](/imgs/content/tutorial/workspace/cpw/interpolation.gif)

可以看到，填入的代码被正确执行并且在渲染面板出现了结果，这个就是插值语法的灵活性。

### 运行
下图是一个多分支执行的示例，组件运行顺序的主要逻辑是：
1. 从所有根组件开始执行，每个组件运行完成后，会发起它的所有下一级后序组件的运行。
2. 组件会等待它的所有上一级的前序组件已经执行完成后再执行：
    - 组件4会等待组件1和组件3执行完成；
    - 组件7会等待组件4和组件6执行完成；
    - 组件8会等待组件5和组件7执行完成；
3. 即使组件已经执行过，也可以选择执行单个组件重新执行。例如更改某个参数再重新执行以查看新的计算结果。
4. 也可以只执行至某个组件，这个模式只会从它的根组件一直执行至目标组件，执行过程中的其他分支将会忽略。

![运行demo-1](/imgs/content/tutorial/workspace/cpw/running-demo-1.gif)

另外，如果组件运行报错，则不会发起它的后序组件的运行，但不会影响其他执行中的分支。

> 和notebook一样，内容区顶部工具栏中有**中止内核**、**重启内核**、**切换内核**操作，他们都会中断正在执行的流水线。

#### 条件判断
当我们的流水线中有多个分支，我们期望某些分支根据运行中计算出的某个条件再判断是否执行的时候，就需要使用条件判断组件。

![条件判断组件](/imgs/content/tutorial/workspace/cpw/condition-cell.png)

它是一个系统内置的特殊组件，它只有3个连接桩：
1. **顶部**连接桩：**只进不出**。
2. 底部**左侧**连接桩：**只出不进**，当条件判断**成功**时执行。
2. 底部**右侧**连接桩：**只出不进**，当条件判断**失败**时执行。


它需要通过输入读取前序组件的某个用于判断的输出值：
- 若该值为Truthy，则执行左边端口的分支，否则执行右边端口输出。
- 也可只连接一边的输出端口。

![运行demo-2](/imgs/content/tutorial/workspace/cpw/running-demo-2.gif)

#### 循环运行
当我们的流水线中有某写需要循环多次执行的组件时，可以使用回环连接指定循环执行的部分，并且通常需要使用条件判断来跳出循环。

如下图示例，我们简单地在组件5上使用参数指定了它的循环执行次数，执行次数足够后输出值会是True，否则为False。

![运行demo-3](/imgs/content/tutorial/workspace/cpw/running-demo-3.gif)

在这个示例中，因为是简单地记录执行次数后跳出，组件5的代码为：

```python
global run_count
if 'run_count' not in globals():
    run_count = 1
else:
    run_count += 1

# 输出项：输出判断条件，output为指定的变量名
output = run_count >= {{execute_count}} # 参数：执行次数，execute_count为指定的变量名
```
组件5代码中使用了 `global` 关键字来声明全局变量用于记录组件5的执行次数。此举是因为前文有提到所有组件的代码实际上都是作为一个函数在Python内核中执行的，所以当我们需要记录状态时，需要使用函数外部的状态来记录。

此时全局变量`run_count`已经在内核中记录，当再次执行整个流水线时，他不会再循环执行3次，而是直接判断跳出循环。如果需要确保每次都循环执行，则需要重置状态记录：

```python
if output:
    run_count = 1
```

当然，在实际使用中，循环执行的判断条件有各种各样，请实际需要结合全局状态记录来完成循环的跳出。
